# @marianmeres/searchable - LLM Knowledge Base

## Package Identity
- Name: @marianmeres/searchable
- Version: 2.3.0
- Author: Marian Meres
- License: MIT
- Repository: https://github.com/marianmeres/searchable
- Runtime: Deno-first, with npm distribution
- Module Type: ESM

## Purpose
Fast, customizable in-memory text search index for client-side filtering. Ideal for autocomplete, typeahead, and document filtering when data is already loaded in memory.

## Core Architecture

### Entry Points
- src/mod.ts: Main export (re-exports everything)
- src/searchable.ts: Searchable class (high-level API)
- src/lib/mod.ts: Library utilities export

### Key Components

#### Searchable Class (src/searchable.ts)
High-level search API managing normalization, tokenization, and search strategies.

Constructor Options (SearchableOptions):
- caseSensitive: boolean (default: false)
- accentSensitive: boolean (default: false)
- isStopword: (word: string) => boolean (default: no filter)
- normalizeWord: (word: string) => string | string[] (default: noop)
- index: "inverted" | "trie" (default: "inverted")
- nonWordCharWhitelist: string (default: "@-")
- ngramsSize: 0 | 3 | 4 | 5 | (3|4|5)[] (default: 0)
- querySomeWordMinLength: number (default: 1)
- defaultSearchOptions: { strategy, maxDistance }
- lastQueryHistoryLength: number (default: 5)

Public Methods:
- add(input: string, docId: string, strict?: boolean): number
- addBatch(documents: [string, string][] | Record<string, string>, strict?: boolean): { added: number, errors: Array }
- search(query: string, strategy?: "exact"|"prefix"|"fuzzy", options?: { maxDistance: number }): string[]
- searchExact(query: string): string[]
- searchByPrefix(query: string): string[]
- searchFuzzy(query: string, maxDistance?: number): string[]
- toWords(input: string, isQuery?: boolean): string[]
- dump(stringify?: boolean): string | Record<string, any>
- restore(dump: any): boolean

Static Methods:
- Searchable.merge(indexes: Searchable[]): { search: (query: string) => string[] }

Properties:
- wordCount: number
- lastQuery: { history: string[], raw: string | undefined, used: string | undefined }
- __index: Index (internal access)

#### Index Implementations

Abstract Index (src/lib/index-abstract.ts):
Abstract base class defining the interface for index implementations.

InvertedIndex (src/lib/index-inverted.ts):
Hash map-based implementation.
- Internal: #wordToDocIds: Map<string, Set<string>>
- Internal: #docIdToWords: Map<string, Set<string>>
- Best for: < 100k unique words, exact/fuzzy searches, memory-constrained scenarios
- Performance: O(1) exact lookup, O(n) prefix iteration

TrieIndex (src/lib/index-trie.ts):
Trie (prefix tree) implementation.
- Internal: TrieNode with children Map, isEOW flag, docIds Set
- Best for: > 100k unique words, prefix-heavy workloads
- Performance: O(k) prefix lookup where k = prefix length

Common Index Interface:
- addWord(word: string, docId: string): boolean
- removeWord(word: string, docId: string): boolean
- removeDocId(docId: string): number
- searchExact(word: string): string[]
- searchByPrefix(prefix: string, returnWithDistance?: boolean): string[] | Record<string, number>
- searchFuzzy(word: string, maxDistance?: number, returnWithDistance?: boolean): string[] | Record<string, number>
- searchByDocId(docId: string): string[]
- getAllWords(): string[]
- getAllDocIds(): string[]
- dump(): { version?: string, words: Record<string, string[]> }
- restore(data): boolean

#### Utility Functions

normalize (src/lib/normalize.ts):
- normalize(input: string, options?: { caseSensitive, accentSensitive }): string
- Applies lowercasing and accent removal based on options

tokenize (src/lib/tokenize.ts):
- tokenize(inputString: string, nonWordCharWhitelist?: string): string[]
- Splits string using Unicode-aware word boundaries
- Uses regex pattern: [^\p{L}\p{N}\p{Pc}${whitelist}]+

unaccent (src/lib/unaccent.ts):
- unaccent(input: string): string
- Uses NFD normalization to remove diacritical marks

levenshteinDistance (src/lib/levenshtein.ts):
- levenshteinDistance(source: string, target: string): number
- Standard dynamic programming implementation for edit distance

createNgrams (src/lib/ngram.ts):
- createNgrams(normalizedText: string, size?: number, options?: { padChar }): string[]
- Generates n-grams for fuzzy search enhancement

intersect (src/lib/intersect.ts):
- intersect<T>(...arrays: (readonly T[])[]): T[]
- Returns elements appearing in all input arrays (AND logic for multi-word queries)

## Search Strategies

### Exact Search
- Direct hash lookup
- All query words must match exactly
- Fastest strategy
- Use case: Known identifiers, codes

### Prefix Search (default)
- Matches words starting with query terms
- Results sorted by Levenshtein distance
- Recommended for autocomplete/typeahead
- Performance: Fast with trie, moderate with inverted

### Fuzzy Search
- Uses Levenshtein distance for similarity matching
- maxDistance parameter controls tolerance (default: 2)
- Results sorted by distance
- Slowest strategy, use judiciously

## N-grams Support
- Enable with ngramsSize option: [3], [3, 4], [3, 4, 5]
- Generates substrings for partial matching
- Increases memory footprint
- Useful for matching word fragments

## Serialization
- dump(): Exports index to JSON-serializable structure
- restore(): Rebuilds index from dump
- Format: { version: "1.0", words: { word: [docId1, docId2, ...] } }

## File Structure
```
src/
  mod.ts                    # Main export
  searchable.ts             # Searchable class
  lib/
    mod.ts                  # Lib exports
    index-abstract.ts       # Abstract Index class
    index-inverted.ts       # InvertedIndex implementation
    index-trie.ts           # TrieIndex implementation
    levenshtein.ts          # Edit distance algorithm
    normalize.ts            # Text normalization
    tokenize.ts             # Word tokenization
    ngram.ts                # N-gram generation
    unaccent.ts             # Diacritical mark removal
    intersect.ts            # Array intersection utility
tests/
  searchable.test.ts        # Main integration tests
  inverted.test.ts          # InvertedIndex unit tests
  trie.test.ts              # TrieIndex unit tests
  levenshtein.test.ts       # Levenshtein tests
  normalize.test.ts         # Normalization tests
  tokenize.test.ts          # Tokenization tests
  ngram.test.ts             # N-gram tests
  unaccent.test.ts          # Unaccent tests
bench/
  bench.ts                  # Deno benchmark suite
scripts/
  build-npm.ts              # NPM package build script
example/
  dist/                     # Built distribution for example
  movies.json               # Sample movie database
```

## Build System
- Primary: Deno with deno.json configuration
- NPM Build: scripts/build-npm.ts
  - Copies src to .npm-dist
  - Transforms .ts imports to .js
  - Runs tsc for transpilation
  - Outputs to .npm-dist/dist

## Commands
- deno task test: Run tests with watch mode
- deno task npm:build: Build npm package
- deno task npm:publish: Build and publish to npm
- deno bench bench/bench.ts: Run benchmarks

## Performance Characteristics (M2 chip, ~2500 movie records)
| Strategy | Inverted Index | Trie Index |
|----------|----------------|------------|
| Exact    | ~16 us         | ~17 us     |
| Prefix   | ~620 us        | ~297 us    |
| Fuzzy    | ~18 ms         | ~69 ms     |

Recommendation: Use "inverted" for general use; use "trie" only for prefix-heavy workloads with large vocabularies.

## Common Usage Patterns

### Basic Usage
```typescript
import { Searchable } from '@marianmeres/searchable';
const index = new Searchable();
index.add("james bond", "007");
const results = index.search("bond"); // ["007"]
```

### Batch Loading
```typescript
const index = new Searchable();
index.addBatch([
  ["doc1", "text one"],
  ["doc2", "text two"],
]);
// or
index.addBatch({ doc1: "text one", doc2: "text two" });
```

### Multiple Indexes with Merge
```typescript
const names = new Searchable({ defaultSearchOptions: { strategy: "prefix" } });
const content = new Searchable({ defaultSearchOptions: { strategy: "fuzzy" } });
const merged = Searchable.merge([names, content]);
const results = merged.search("query");
```

### With N-grams
```typescript
const index = new Searchable({ ngramsSize: [3, 4] });
// Enables partial word matching
```

### Persistence
```typescript
// Save
const dump = index.dump();
localStorage.setItem("index", dump);
// Restore
const index = new Searchable();
index.restore(localStorage.getItem("index"));
```

## Dependencies
- Deno standard library (@std/assert, @std/fs, @std/path)
- Zero runtime dependencies for npm package

## TypeScript Types Exported
- Searchable (class)
- SearchableOptions (interface)
- LastQuery (interface)
- Index (abstract class)
- InvertedIndex (class)
- TrieIndex (class)
- All utility functions
